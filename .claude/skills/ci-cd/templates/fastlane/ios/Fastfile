# iOS Fastfile
#
# Copy to: ios/fastlane/Fastfile

default_platform(:ios)

platform :ios do

  # ─────────────────────────────────────────────────────────────
  # Code Signing with Match
  # ─────────────────────────────────────────────────────────────

  desc "Sync certificates and profiles (development)"
  lane :sync_dev do
    match(type: "development", readonly: is_ci)
  end

  desc "Sync certificates and profiles (ad-hoc)"
  lane :sync_adhoc do
    match(type: "adhoc", readonly: is_ci)
  end

  desc "Sync certificates and profiles (app-store)"
  lane :sync_appstore do
    match(type: "appstore", readonly: is_ci)
  end

  # ─────────────────────────────────────────────────────────────
  # Build Lanes
  # ─────────────────────────────────────────────────────────────

  desc "Build ad-hoc IPA for testing (Firebase distribution)"
  lane :build_adhoc do
    setup_ci if is_ci
    sync_adhoc

    # Build Flutter app
    Dir.chdir("..") do
      sh("flutter build ios --release --no-codesign")
    end

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "ad-hoc",
      output_directory: "../build/ios/ipa",
      output_name: "app-adhoc.ipa"
    )
  end

  desc "Build release IPA for App Store"
  lane :build_release do
    sync_appstore

    # Build Flutter app
    Dir.chdir("..") do
      sh("flutter build ios --release --no-codesign")
    end

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "app-release.ipa"
    )
  end

  # ─────────────────────────────────────────────────────────────
  # Deployment Lanes
  # ─────────────────────────────────────────────────────────────

  desc "Deploy to TestFlight"
  lane :beta do
    setup_ci if is_ci

    # Use API key for CI authentication
    if is_ci
      api_key = app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY"],
        is_key_content_base64: true
      )
    end

    build_release

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false
    )
  end

  desc "Deploy to App Store"
  lane :release do
    setup_ci if is_ci

    if is_ci
      api_key = app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY"],
        is_key_content_base64: true
      )
    end

    build_release

    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )
  end

  # ─────────────────────────────────────────────────────────────
  # Utility Lanes
  # ─────────────────────────────────────────────────────────────

  desc "Register new device"
  lane :register_device do |options|
    device_name = options[:name] || prompt(text: "Device name: ")
    device_udid = options[:udid] || prompt(text: "Device UDID: ")

    register_devices(
      devices: {
        device_name => device_udid
      }
    )

    # Regenerate adhoc profiles to include new device
    match(type: "adhoc", force_for_new_devices: true)
  end

end
